{% load i18n %}
<script>
    const changeSecretModalTime = document.getElementById('changeSecretModalTime');
    const changeSecretModalContinueButton = document.getElementById('changeSecretModalContinueButton');
    const secret_placeholder = '{{ placeholder }}'
    const needsChangingWaitingTime = 5  // seconds
    var changeSecretModal = null;
    var shouldShowModal = {{ needs_changing|lower }};
    const okButtonHandler = function () {
        closeModal();
    };

    function getSecret(callback) {
        if (shouldShowModal) {
            showModal();
        } else {
            $.ajax({
                url: "{{ secret_url }}",
                type: "get",
                dataType: "json",
                success: function (data) {
                    callback(data['password']);
                },
            });
        }
    }

    function getSecretSync() {
        let secret;
        $.ajax({
            url: "{{ secret_url }}",
            async: false,
            type: "get",
            dataType: "json",
            success: function (data) {
                secret = data;
            },
        });
        return secret;
    }

    function reveal(password) {
        let revBtnTooltip = bootstrap.Tooltip.getInstance('#revealButton')
        revBtnTooltip.setContent({'.tooltip-inner': '{% trans "Hide plain text" %}'})

        const revBtn = document.getElementById('revealButton')
        revBtn.setAttribute('onclick', 'unreveal()')
        revBtn.querySelector('i').classList.remove('fa-magic')
        revBtn.querySelector('i').classList.add('fa-shield')

        let passwordField = document.getElementById('password-field')
        passwordField.value = password
        passwordField.disabled = false
    }

    function unreveal() {
        let revBtnTooltip = bootstrap.Tooltip.getInstance('#revealButton')
        revBtnTooltip.setContent({'.tooltip-inner': '{% trans "Reveal as plain text" %}'})

        const revBtn = document.getElementById('revealButton')
        revBtn.setAttribute('onclick', 'getSecret(reveal)');
        revBtn.querySelector('i').classList.remove('fa-shield')
        revBtn.querySelector('i').classList.add('fa-magic')

        let passwordField = document.getElementById('password-field')
        passwordField.value = secret_placeholder
        passwordField.disabled = true
    }

    function showModal() {
        changeSecretModal = new bootstrap.Modal('#changeSecretModal');
        changeSecretModal.show();

        let secondsLeft = needsChangingWaitingTime;
        changeSecretModalTime.innerText = secondsLeft.toString();

        function countdown() {
            changeSecretModalTime.innerText = secondsLeft.toString();
            secondsLeft--;
            if (secondsLeft > 0) {
                changeSecretModalTime.innerText = secondsLeft.toString()
            } else {
                changeSecretModalTime.remove()
                changeSecretModalContinueButton.style.display = 'unset'
                clearInterval(intervalId);
            }
        }

        let intervalId = setInterval(countdown, 1000);
        shouldShowModal = false;
    }

    function closeModal() {
        changeSecretModal.hide();
        document.getElementById('copy-password').removeAttribute('onclick');
        setUpClipboard();
    }

    function setUpClipboard() {
        new window.ClipboardJS("#copy-password", {
            text: function () {
                return getSecretSync()['password'];
            }
        }).on('success', function (e) {
            e.clearSelection();
            notyf.success("{% trans "Password has been copied to your clipboard." %}");
        });

        new window.ClipboardJS("#copy-url").on('success', function (e) {
            e.clearSelection();
            notyf.success("{% trans "URL has been copied to your clipboard." %}");
        });

        new window.ClipboardJS("#copy-username").on('success', function (e) {
            e.clearSelection();
            notyf.success("{% trans "Username has been copied to your clipboard." %}");
        });
    }
</script>

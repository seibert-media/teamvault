{% extends "base.html" %}
{% load i18n %}
{% load smart_pagination %}

{% block title %}{% trans "Manage user" %}{% endblock %}

{% block content %}
{% partialdef user-pending-secrets-container inline %}
<div class="row mt-4">
    <div class="col-md-12">
        <div class="alert alert-warning d-flex align-items-center" role="alert">
            <i class="fa fa-exclamation-triangle fa-fw me-2"></i>
            <div>
                {% blocktrans %}The following secrets are marked as needing change due to this deactivated
                user's access.{% endblocktrans %}
            </div>
        </div>

        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">

                <div class="input-group" style="min-width: 300px;">
                    <span class="input-group-text bg-transparent text-muted border-end-0 pe-2">
                        <i class="fa fa-search"></i>
                    </span>
                    <input type="text" name="q" class="form-control bg-transparent border-start-0 ps-2 shadow-none"
                        placeholder="{% trans 'Search secrets...' %}" value="{{ request.GET.q|default:'' }}"
                        autocomplete="off" hx-get="{% url 'accounts.user-pending-secrets' user.username %}"
                        hx-include="[name='page_size']" hx-trigger="keyup changed delay:500ms, search"
                        hx-target="#secrets-table-wrapper" hx-swap="innerHTML">
                </div>

                <span class="text-muted ms-auto pe-3 text-end" id="secrets-count-wrapper">
                    {% blocktrans count count=paginator.count %}
                    {{ count }} secret needs changing.
                    {% plural %}
                    {{ count }} secrets need changing.
                    {% endblocktrans %}
                </span>
            </div>
            <div id="secrets-table-wrapper" class="card-body p-0">

                {% partialdef user-pending-secrets-content inline %}
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>{% trans "Name" %}</th>
                            <th>{% trans "Actions" %}</th>
                            <th class="text-nowrap">{% trans "Status" %}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for secret in pending_secrets %}
                        <tr>
                            <td>
                                <a href="{{ secret.get_absolute_url }}">
                                    {{ secret.name }}
                                </a>
                            </td>
                            <td class="text-nowrap">
                                {% if secret.readable_for_admin %}
                                <a class="btn btn-light btn-sm" href="{% url 'secrets.secret-edit' secret.hashid %}">
                                    <i class="fa fa-pencil fa-fw text-info-emphasis"></i> {% trans "Edit" %}
                                </a>
                                <a class="btn btn-light btn-sm" href="{% url 'secrets.secret-delete' secret.hashid %}">
                                    <i class="fa fa-trash fa-fw text-danger-emphasis"></i> {% trans "Delete" %}
                                </a>
                                {% else %}
                                <button type="button" class="btn btn-light btn-sm" data-bs-toggle="modal"
                                    data-bs-target="#share-secret-modal-{{ secret.hashid }}">
                                    <i class="fa fa-share fa-fw text-secondary"></i> {% trans "Share with me" %}
                                </button>
                                <div class="modal fade" id="share-secret-modal-{{ secret.hashid }}" tabindex="-1"
                                    aria-hidden="true">
                                    <div
                                        class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-xl modal-fullscreen-md-down">
                                        <div class="modal-content"
                                            hx-get="{% url 'secrets.secret-share' hashid=secret.hashid %}?share_with_self=1"
                                            hx-trigger="load, refreshShareData from:body"></div>
                                    </div>
                                </div>
                                {% endif %}
                            </td>
                            <td class="text-nowrap">
                                <span class="badge bg-warning text-dark">{% trans "needs changing" %}</span>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="3" class="text-center text-muted py-3">
                                {% trans "No secrets found matching your search." %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <input type="hidden" name="page" id="current-page" value="{{ page_obj.number }}">

                <div class="card-footer border-top-0">
                    <div class="row align-items-center">
                        <div class="col-auto">
                            <a href="{% url 'accounts.user-pending-secrets-csv' username=user.username %}"
                                class="btn btn-outline-primary btn-sm text-nowrap">
                                <i class="fa fa-file-csv fa-fw"></i> {% trans "Export CSV (all pending secrets)" %}
                            </a>
                        </div>
                        <div class="col d-flex justify-content-end" hx-boost="true" hx-target="#secrets-table-wrapper"
                            hx-push-url="false">
                            {% url "accounts.user-pending-secrets" username=user.username as pending_secrets_url %}
                            {% include "pagination.html" with url=pending_secrets_url target="#secrets-table-wrapper" %}
                        </div>
                    </div>
                </div>
                {% if is_htmx %}
                <span class="text-muted ms-auto pe-3 text-end" id="secrets-count-wrapper" hx-swap-oob="true">
                    {% blocktrans count count=paginator.count %}
                    {{ count }} secret needs changing.
                    {% plural %}
                    {{ count }} secrets need changing.
                    {% endblocktrans %}
                </span>
                {% endif %}
                {% endpartialdef %}
            </div>
        </div>
    </div>
</div>
<div hx-get="{% url 'accounts.user-pending-secrets' user.username %}" hx-trigger="pendingSecretsRefresh from:body"
    hx-include="#current-page, [name='q'], [name='page_size']" hx-target="#secrets-table-wrapper" hx-swap="innerHTML"
    style="display:none"></div>
<script>
    document.body.addEventListener('pendingSecretsRefresh', function () {
        document.querySelectorAll('.modal.show').forEach(function (m) {
            var instance = bootstrap.Modal.getInstance(m);
            if (instance) instance.hide();
        });
    });
</script>
{% endpartialdef %}
{% endblock %}